(()=>{"use strict";function t(t,e){return t.some((t=>e.includes(t)))}function e(t){return Math.round(10*t)/10}async function o(t){const e=(await miro.board.widgets.get({type:"FRAME"})).filter((e=>e.title===t));if(0===e.length)throw alert("「"+e+"」というタイトルがついたフレームが存在しません。"),new Error("「"+e+"」というタイトルがついたフレームが存在しません。");if(e.length>1)throw alert("「"+e+"」というタイトルがついたフレームが複数存在します。"),new Error("「"+e+"」というタイトルがついたフレームが複数存在します。");return e[0]}async function i(){const e=(await miro.board.widgets.get({type:"STICKER"})).filter((t=>t.tags.some((t=>"finish"===t.title)))).map((t=>t.id));if(0===e.length)throw alert("finishのタグがついた付箋が存在しません。"),new Error("finishのタグがついた付箋が存在しません。");if(e.length>1)throw alert("finishのタグがついた付箋が複数存在します。"),new Error("finishのタグがついた付箋が複数存在します。");const o=(await miro.board.widgets.get({type:"FRAME"})).find((o=>t(o.childrenIds,e)));if(!o)throw alert("finishのタグの付箋が「DayX」のフレームに置かれていません。"),new Error("finishのタグの付箋が「DayX」のフレームに置かれていません。");return o.title}async function r(t,e,o){const i=await miro.board.tags.get({title:"自動生成"});if(0===i.length)throw alert("「自動生成」というタグがこのボードにありません。作ってください。"),new Error("「自動生成」というタグがこのボードにありません。作ってください。");const r=e.childrenIds,n=(await async function(t){const e=(await miro.board.widgets.get({type:"SHAPE"})).filter((e=>e.plainText===t));if(0===e.length)throw alert("「"+t+"」という枠は存在しません。"),new Error("「"+t+"」という枠は存在しません。");return e}(o)).filter((t=>r.includes(t.id)));if(0===n.length)throw alert("フレーム「"+e.title+"」上に「"+o+"」という枠が存在しません。"),new Error("フレーム「"+e.title+"」上に「"+o+"」という枠が存在しません。");if(n.length>1)throw alert("フレーム「"+e.title+"」上に「"+o+"」という枠が複数存在します。"),new Error("フレーム「"+e.title+"」上に「"+o+"」という枠が複数存在します。");const a=n[0].bounds.width/199,s=await miro.board.widgets.create({type:"STICKER",text:t,x:n[0].x,y:n[0].y,scale:a,style:{stickerBackgroundColor:0}});i[0].widgetIds.push(s[0].id),await miro.board.tags.update({id:i[0].id,widgetIds:i[0].widgetIds})}async function n(t,e,o,i,r,n){const l=[];for(const[s,c]of t.entries()){const d=await a(c,i,s,t.length-1,e,o,r,n);l.push(d)}for(let e=0;e<t.length-1;e++)await s(l[e],l[e+1],r,n);return l}async function a(t,o,i,r,n,a,s,l){const c=n-a,d=o.right-o.left,g=o.left+d/r*i,h=o.bottom-o.top,f=o.bottom-h/c*(t-a);return await miro.board.widgets.create({type:"TEXT",scale:3*s,text:e(t).toString(),x:g+50*s,y:f-50*s,style:{textColor:"#808080"}}),(await miro.board.widgets.create({type:"SHAPE",style:{shapeType:4,borderColor:"transparent",backgroundColor:l},x:g,y:f,height:30*s,width:30*s}))[0]}async function s(t,e,o,i){await miro.board.widgets.create({type:"LINE",style:{lineColor:i,lineThickness:8*o},startPosition:{x:t.x,y:t.y},endPosition:{x:e.x,y:e.y}})}miro.onReady((()=>{miro.initialize({extensionPoints:{bottomBar:{title:"Graph maker",svgIcon:'<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><g><rect fill="none" height="24" width="24"/></g><g><g><path d="M21,8c-1.45,0-2.26,1.44-1.93,2.51l-3.55,3.56c-0.3-0.09-0.74-0.09-1.04,0l-2.55-2.55C12.27,10.45,11.46,9,10,9 c-1.45,0-2.27,1.44-1.93,2.52l-4.56,4.55C2.44,15.74,1,16.55,1,18c0,1.1,0.9,2,2,2c1.45,0,2.26-1.44,1.93-2.51l4.55-4.56 c0.3,0.09,0.74,0.09,1.04,0l2.55,2.55C12.73,16.55,13.54,18,15,18c1.45,0,2.27-1.44,1.93-2.52l3.56-3.55 C21.56,12.26,23,11.45,23,10C23,8.9,22.1,8,21,8z"/><polygon points="15,9 15.94,6.93 18,6 15.94,5.07 15,3 14.08,5.07 12,6 14.08,6.93"/><polygon points="3.5,11 4,9 6,8.5 4,8 3.5,6 3,8 1,8.5 3,9"/></g></g></svg>',onClick:async()=>{console.log("====以下、自動生成付箋の削除===="),await async function(){const t=(await miro.board.widgets.get({type:"STICKER"})).filter((t=>t.tags.some((t=>"自動生成"===t.title)))).map((t=>t.id));await miro.board.widgets.deleteById(t);const e=(await o("スプリントバーンアップチャート")).childrenIds;await miro.board.widgets.deleteById(e)}(),console.log("====以下、PBI毎の合計時間の演算====");const a=await async function(){const t=(await miro.board.widgets.get({type:"STICKER"})).filter((t=>t.tags.some((t=>"PBIリスト"===t.title))));if(0===t.length)throw alert("PBIリストのタグがついた付箋が存在しません。"),new Error("PBIリストのタグがついた付箋が存在しません。");if(t.length>1)throw alert("PBIリストのタグがついた付箋が複数存在します。"),new Error("PBIリストのタグがついた付箋が複数存在します。");const i=t[0].plainText.split(" "),n=[];for(const t of i){const i=(await miro.board.widgets.get({type:"STICKER"})).filter((e=>e.tags.some((e=>e.title===t))&&e.tags.some((t=>t.title.includes("予定："))))).reduce(((t,e)=>t+Number(e.tags.find((t=>t.title.includes("予定："))).title.split("：")[1].replace("h",""))),0),a=await o(t);await r(`${t}<br>合計<br>${e(i)}h`,a,"タスク 合計時間"),n.push({name:t,hour:i})}return n}();console.log("====以下、全PBIの合計時間の演算====");const s=await async function(t){const i=t.reduce(((t,e)=>t+e.hour),0),n=await o("sprint information");return await r(`合計タスク時間<br>${e(i)}h`,n,"全タスク 合計時間"),i}(a);console.log("====以下、1日で消化したタスク時間の演算====");const l=await async function(){const o=await miro.board.widgets.get({type:"FRAME"}),n=await miro.board.widgets.get({type:"STICKER"}),a=o.filter((t=>t.title.includes("Day")));let s=[];const l=await i();for(const o of a){let i=0;const a=n.filter((t=>t.tags.some((t=>"開発時間"===t.title)))).map((t=>t.id));if(!t(o.childrenIds,a))break;for(const t of o.childrenIds){const e=n.filter((t=>t.tags.some((t=>t.title.includes("予定："))))).find((e=>e.id===t));i+=e?Number(e.tags.find((t=>t.title.includes("予定："))).title.split("：")[1].replace("h","")):0}if(await r(`${o.title}<br>消化タスク<br>${e(i)}h`,o,"消化タスク 合計時間"),s.push({frame:o,hour:i}),o.title===l)break}return s.sort(((t,e)=>{const o=Number(t.frame.title.replace("Day","")),i=Number(e.frame.title.replace("Day",""));return o<i?-1:i<o?1:-1})),s}();console.log("====以下、1日で確保できる開発時間の取得====");const c=await async function(){const e=(await miro.board.widgets.get({type:"FRAME"})).filter((t=>t.title.includes("Day"))),o=(await miro.board.widgets.get({type:"STICKER"})).filter((t=>t.tags.some((t=>"開発時間"===t.title)))),r=[];for(const i of e)if(t(i.childrenIds,o.map((t=>t.id)))){const t=Number(o.find((t=>i.childrenIds.includes(t.id))).plainText.replace("h",""));r.push({frame:i,hour:t})}r.sort(((t,e)=>{const o=Number(t.frame.title.replace("Day","")),i=Number(e.frame.title.replace("Day",""));return o<i?-1:i<o?1:-1}));const n=await i();if(!r.some((t=>t.frame.title===n)))throw alert("finishの付箋が不適切なフレームの上にあります。置かれている場所:"+n),new Error("finishの付箋が不適切なフレームの上にあります。置かれている場所:"+n);if(Number(r.slice(-1)[0].frame.title.replace("Day",""))!==r.length)throw alert("DayXフレームの開発時間の付箋に抜けがあります"),new Error("DayXフレームの開発時間の付箋に抜けがあります");return r}();console.log("====以下、1日で消費したバッファの演算====");const d=await async function(t,o){let i=[];for(let n=0;n<t.length;n++){if(t[n].frame.title!==o[n].frame.title)throw alert("日次タスク消化時間と日次開発時間の順番が異なっています。"+t[n].frame.title+" and "+o[n].frame.title),new Error("日次タスク消化時間と日次開発時間の順番が異なっています。"+t[n].frame.title+" and "+o[n].frame.title);const a=e(o[n].hour-t[n].hour);i.push({frame:t[n].frame,hour:a}),await r(`バッファ消化<br>${a}h`,t[n].frame,"消費バッファ 合計時間")}return i}(l,c);console.log("====以下、全日で確保できる開発時間の演算====");const g=await async function(t){const e=await o("sprint information"),i=t.reduce(((t,e)=>t+e.hour),0);return await r(`開発時間<br>${i}h`,e,"開発合計 持ち時間"),i}(c);console.log("====以下、全日のバッファの合計の演算====");const h=await async function(t,i){const n=await o("sprint information"),a=e(i-t);return await r(`バッファ<br>合計時間<br>${a}h`,n,"バッファ 合計時間"),a}(s,g);console.log("====グラフの描画===="),await async function(t,e,i,r,a){console.log("====3つのグラフの点の算出====");const s=function(t,e,o){const i=[t];for(let t=1;t<=o;t++)t<=e.length?i.push(i[t-1]-e[t-1]):i.push(i[t-1]);return i}(t,e,i),l=function(t,e){const o=[0];for(let i=1;i<=e;i++){const e=t[i-1]?o[i-1]+t[i-1]:o[i-1];o.push(e)}return o}(r,i),c=function(t,e){const o=t/e,i=[0];for(let t=1;t<=e;t++)i.push(i[t-1]+o);return i}(a,i);console.log("====グラフの軸描画====");const{minHour:d,maxHour:g}=(h=s.concat(l).concat(c),{minHour:Math.min(...h),maxHour:Math.max(...h)});var h;const{basePoints:f,sizeRate:w}=await async function(t,e){const i=await o("スプリントバーンアップチャート"),r=i.height/1800,{left:n,right:a,top:s,bottom:l}=i.bounds,c=n+100*r,d=a-100*r,g=s+100*r,h=l-100*r,f=g+100*r,w=h-100*r,u=d-100*r,y=w-f,p=(0-t)/(e-t);console.log(p);const m=w-y*p;return await miro.board.widgets.create([{type:"LINE",startPosition:{x:c,y:m},endPosition:{x:d,y:m}},{type:"LINE",startPosition:{x:c,y:h},endPosition:{x:c,y:g}},{type:"TEXT",text:"START",x:c,y:m+50*r,scale:3*r,width:50*r,style:{textAlign:"c"}}]),{basePoints:{top:f,bottom:w,left:c,right:u,originalTop:g,originalBottom:h,originalRight:d,zero:m},sizeRate:r}}(d,g);console.log("====残バッファグラフの描画====");const u=await n(s,g,d,f,w,"#f4a460");console.log("====消化タスクグラフの描画===="),await n(l,g,d,f,w,"#4169e1"),console.log("====理想線の描画===="),await n(c,g,d,f,w,"#3cb371"),console.log("====本日の枠の描画===="),await async function(t,e,o,i){const r=o[e].x,n=(t.originalTop+t.originalBottom)/2,a=t.originalBottom-t.originalTop,s=200*i,l={backgroundColor:"transparent",borderWidth:5*i,borderColor:"#ff1493"};await miro.board.widgets.create({type:"SHAPE",x:r,y:n,height:a,width:s,style:l})}(f,e.length,u,w),console.log("====メモリ描画===="),await async function(t,e,o,i,r){const n=[],a=Math.floor(t/10),s=Math.floor(e/10)+(Math.floor(e)%10==0?0:1),l=(r.bottom-r.top)/(t-e);for(let t=s;t<=a;t++)0!==t&&(n.push({type:"SHAPE",x:r.left,y:r.zero-10*t*l,width:20*o,height:20*o,style:{shapeType:4,backgroundColor:"#000000",borderColor:"transparent"}}),n.push({type:"LINE",startPosition:{x:r.left,y:r.zero-10*t*l},endPosition:{x:r.originalRight,y:r.zero-10*t*l},style:{lineColor:"#c0c0c0",lineThickness:3*o,lineStyle:1}}),n.push({type:"TEXT",x:r.left-30*o,y:r.zero-10*t*l,text:(10*t).toString(),scale:3*o}));i.forEach(((t,e)=>{0!==e&&(n.push({type:"SHAPE",x:t.x,y:r.zero,width:20*o,height:20*o,style:{shapeType:4,backgroundColor:"#000000",borderColor:"transparent"}}),n.push({type:"LINE",startPosition:{x:t.x,y:r.originalBottom},endPosition:{x:t.x,y:r.originalTop},style:{lineColor:"#c0c0c0",lineThickness:3*o,lineStyle:1}}),n.push({type:"TEXT",x:t.x,y:r.zero+50*o,text:"Day"+e,scale:3*o}))})),await miro.board.widgets.create(n)}(g,d,w,u,f)}(h,d.map((t=>t.hour)),c.length,l.map((t=>t.hour)),s),console.log("====終わり====")}}}})}))})();