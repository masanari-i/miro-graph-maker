<!DOCTYPE html>
<html lang="ja">
<head>
  <script src="https://miro.com/app/static/sdk.1.1.js"></script>
  <script>
    miro.onReady(() => {
      function compareTwoIdArray(idArray1, idArray2) {
        return idArray1.some(id => idArray2.includes(id))
      }
      function round(number) {
        return Math.round(number * 10) / 10
      }
      async function getShapeWidget(text) {
        const textWidgets = await miro.board.widgets.get({type: "SHAPE"})
        const targetTexts = textWidgets.filter(textWidget => textWidget.plainText === text)
        if (targetTexts.length === 0) {
          alert("「"+text+"」という枠は存在しません。")
          throw new Error("「"+text+"」という枠は存在しません。")
        }
        return targetTexts
      }
      async function createSticker(text, frame, word) {
        const autoMakingTag = await miro.board.tags.get({title: "自動生成"})
        if (autoMakingTag.length === 0) {
          alert("「自動生成」というタグがこのボードにありません。作ってください。")
          throw new Error("「自動生成」というタグがこのボードにありません。作ってください。")
        }
        const childrenIds = frame.childrenIds
        const targetTexts = (await getShapeWidget(word)).filter(textWidget => childrenIds.includes(textWidget.id))
        if (targetTexts.length === 0) {
          alert("フレーム「"+frame.title+"」上に「"+word+"」という枠が存在しません。")
          throw new Error("フレーム「"+frame.title+"」上に「"+word+"」という枠が存在しません。")
        }
        if (targetTexts.length > 1) {
          alert("フレーム「"+frame.title+"」上に「"+word+"」という枠が複数存在します。")
          throw new Error("フレーム「"+frame.title+"」上に「"+word+"」という枠が複数存在します。")
        }
        // 199.0はStickerのデフォルトのサイズ
        const expectedStickerWidth = targetTexts[0].bounds.width / 199.0
        const createdSticker = await miro.board.widgets.create({type: "STICKER", text, x: targetTexts[0].x, y: targetTexts[0].y, scale: expectedStickerWidth, style: {stickerBackgroundColor: 15}})
        autoMakingTag[0].widgetIds.push(createdSticker[0].id)
        await miro.board.tags.update({id: autoMakingTag[0].id, widgetIds: autoMakingTag[0].widgetIds})
      }
      async function getSprintInformationFrame() {
        const targetFrame = (await miro.board.widgets.get({type: "FRAME"})).filter(frame => frame.title === "sprint information")
        if (targetFrame.length === 0) {
          alert("sprint informationというタイトルがついたフレームが存在しません。")
          throw new Error("sprint informationというタイトルがついたフレームが存在しません。")
        } else if (targetFrame.length > 1) {
          alert("sprint informationというタイトルがついたフレームが複数存在します。")
          throw new Error("sprint informationというタイトルがついたフレームが複数存在します。")
        }
        return targetFrame[0]
      }
      async function getLatestDay() {
        const stickerIds = (await miro.board.widgets.get({type: "STICKER"})).filter(sticker => sticker.tags.some(tag => tag.title === "finish")).map(sticker => sticker.id)
        if (stickerIds.length === 0) {
          alert("finishのタグがついた付箋が存在しません。")
          throw new Error("finishのタグがついた付箋が存在しません。")
        } else if (stickerIds.length > 1) {
          alert("finishのタグがついた付箋が複数存在します。")
          throw new Error("finishのタグがついた付箋が複数存在します。")
        }
        const targetFrame = (await miro.board.widgets.get({type: "FRAME"})).find((frame) => compareTwoIdArray(frame.childrenIds, stickerIds))
        if (!targetFrame) {
          alert('finishのタグの付箋が「DayX」のフレームに置かれていません。')
          throw new Error('finishのタグの付箋が「DayX」のフレームに置かれていません。')
        }
        return targetFrame.title
      }
      async function calculateDoneTaskHoursInADay() {
        const frames = await miro.board.widgets.get({type: 'FRAME'})
        const stickers = await miro.board.widgets.get({type: "STICKER"})
        const targetFrames = frames.filter((frame) => frame.title.includes("Day"))
        let totalHoursList = []
        const latestDay = await getLatestDay()
        for (const frame of targetFrames) {
          let totalHourInADay = 0
          const developHoursStickerIds = stickers.filter(sticker => sticker.tags.some(tag => tag.title === "開発時間")).map(sticker => sticker.id)
          if (!compareTwoIdArray(frame.childrenIds, developHoursStickerIds)) break
          for (const id of frame.childrenIds) {
            const filteredSticker = stickers.filter((sticker) => sticker.tags.some((tag) => tag.title.includes("予定：")))
            const targetSticker = filteredSticker.find((sticker) => sticker.id === id)
            const hour = targetSticker ? Number(targetSticker.tags.find((tag) => tag.title.includes("予定：")).title.split("：")[1].replace("h", "")) : 0
            totalHourInADay += hour
          }
          await createSticker(`${frame.title}<br>消化タスク<br>${round(totalHourInADay)}h`, frame, "消化タスク 合計時間")
          totalHoursList.push({frame, hour: totalHourInADay})
          if (frame.title === latestDay) break
        }
        totalHoursList.sort((aFrame, bFrame) => {
          const aNumber = Number(aFrame.frame.title.replace("Day", ""))
          const bNumber = Number(bFrame.frame.title.replace("Day", ""))
          if (aNumber < bNumber) return -1
          if (bNumber < aNumber) return 1
          return -1
        })
        return totalHoursList
      }
      async function calculateAllTaskHoursInABacklog() {
        const PBIListStickers = (await miro.board.widgets.get({type: "STICKER"})).filter((sticker) => sticker.tags.some((tag) => tag.title === "PBIリスト"))
        if (PBIListStickers.length === 0) {
          alert("PBIリストのタグがついた付箋が存在しません。")
          throw new Error("PBIリストのタグがついた付箋が存在しません。")
        } else if (PBIListStickers.length > 1) {
          alert("PBIリストのタグがついた付箋が複数存在します。")
          throw new Error("PBIリストのタグがついた付箋が複数存在します。")
        }
        const PBIListSticker = PBIListStickers[0]
        const PBINameList = PBIListSticker.plainText.split(" ")
        const totalHoursList = []
        for (const PBIName of PBINameList) {
          const stickers = await miro.board.widgets.get({type: "STICKER"})
          const targetTaskStickers = stickers.filter((sticker) => sticker.tags.some(tag => tag.title === PBIName) && sticker.tags.some(tag => tag.title.includes("予定：")))
          const totalHours = targetTaskStickers.reduce((accum, sticker) => {
            return accum + Number(sticker.tags.find(tag => tag.title.includes("予定：")).title.split("：")[1].replace("h", ""))
          }, 0)
          const targetFrame = (await miro.board.widgets.get({type: "FRAME"})).filter(frame => frame.title === PBIName)
          if (targetFrame.length === 0) {
            alert("該当PBIの名前のタイトルがついたフレームが存在しません。PBI名：" + PBIName)
            throw new Error("該当PBIの名前のタイトルがついたフレームが存在しません。PBI名：" + PBIName)
          } else if (targetFrame.length > 1) {
            alert("該当PBIの名前のタイトルがついたフレームが複数存在します。PBI名：" + PBIName)
            throw new Error("該当PBIの名前のタイトルがついたフレームが複数存在します。PBI名：" + PBIName)
          }
          await createSticker(`${PBIName}<br>合計<br>${round(totalHours)}h`, targetFrame[0], "タスク 合計時間")
          totalHoursList.push({name: PBIName, hour: totalHours})
        }
        return totalHoursList
      }
      async function calculateAllTaskHoursInAllBacklogs(hoursInBacklogs) {
        const totalHours = hoursInBacklogs.reduce((accum, info) => accum + info.hour, 0)
        const targetFrame = await getSprintInformationFrame()
        await createSticker(`合計タスク時間<br>${round(totalHours)}h`, targetFrame, "全タスク 合計時間")
        return totalHours
      }
      async function getHoursPreparedForDevelopmentInEachDays() {
        const dayFrames = (await miro.board.widgets.get({type: "FRAME"})).filter(frame => frame.title.includes("Day"))
        const stickers  = await miro.board.widgets.get({type: "STICKER"})
        let targetDayFramesInfo = []
        for (const frame of dayFrames) {
          let hour
          let haveTargetTag = false
          for (const id of frame.childrenIds) {
            const targetSticker = stickers.find(sticker => sticker.id === id)
            if (targetSticker) haveTargetTag = targetSticker.tags.some(tag => tag.title === "開発時間")
            if (haveTargetTag) {
              hour = Number(targetSticker.plainText.replace("h", ""))
              break
            }
          }
          if (haveTargetTag) {
            targetDayFramesInfo.push({frame, hour})
          }
        }
        targetDayFramesInfo.sort((aFrame, bFrame) => {
          const aNumber = Number(aFrame.frame.title.replace("Day", ""))
          const bNumber = Number(bFrame.frame.title.replace("Day", ""))
          if (aNumber < bNumber) return -1
          if (bNumber < aNumber) return 1
          return -1
        })
        const latestDay = await getLatestDay()
        if (!targetDayFramesInfo.some(frameInfo => frameInfo.frame.title === latestDay)) {
          alert('finishの付箋が不適切なフレームの上にあります。置かれている場所:' + latestDay)
          throw new Error('finishの付箋が不適切なフレームの上にあります。置かれている場所:' + latestDay)
        }
        const maxNumber = Number(targetDayFramesInfo.slice(-1)[0].frame.title.replace("Day", ""))
        if (maxNumber !== targetDayFramesInfo.length) {
          alert('DayXフレームの開発時間の付箋に抜けがあります')
          throw new Error('DayXフレームの開発時間の付箋に抜けがあります')
        }
        return targetDayFramesInfo
      }
      async function calculateAllDevelopmentHours(dayFramesInfo) {
        const targetFrame = await getSprintInformationFrame()
        const totalHours = dayFramesInfo.reduce((accum, frameInfo) => accum + frameInfo.hour, 0)
        await createSticker(`開発時間<br>${totalHours}h`, targetFrame, "開発合計 持ち時間")
        return totalHours
      }
      async function calculateConsumedBuffaInEachDays(dayDoneTaskHours, dayFramesInfo) {
        let dayBuffaList = []
        for (let i=0; i<dayDoneTaskHours.length; i++) {
          if (dayDoneTaskHours[i].frame.title !== dayFramesInfo[i].frame.title) {
            alert('日次タスク消化時間と日次開発時間の順番が異なっています。'+ dayDoneTaskHours[i].frame.title + ' and ' + dayFramesInfo[i].frame.title)
            throw new Error('日次タスク消化時間と日次開発時間の順番が異なっています。'+ dayDoneTaskHours[i].frame.title + ' and ' + dayFramesInfo[i].frame.title)
          }
          const hour = round(dayFramesInfo[i].hour - dayDoneTaskHours[i].hour)
          dayBuffaList.push({frame: dayDoneTaskHours[i].frame, hour})
          await createSticker(`バッファ消化<br>${hour}h`, dayDoneTaskHours[i].frame, "消費バッファ 合計時間")
        }
      }
      async function calculateTotalBuffaHours(totalHoursInBacklogs, totalDevelopHours) {
        const targetFrame = await getSprintInformationFrame()
        const totalBuffa = round(totalDevelopHours - totalHoursInBacklogs)
        await createSticker(`バッファ<br>合計時間<br>${totalBuffa}h`, targetFrame, "バッファ 合計時間")
        return totalBuffa
      }
      async function deleteAutoCreatedStickers() {
        const autoCreatedStickerIds = (await miro.board.widgets.get({type: "STICKER"})).filter(sticker => sticker.tags.some(tag => tag.title === "自動生成")).map(sticker => sticker.id)
        await miro.board.widgets.deleteById(autoCreatedStickerIds)
      }
      miro.initialize({
        extensionPoints: {
          bottomBar: {
            title: 'Graph maker',
            svgIcon: '<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><g><rect fill="none" height="24" width="24"/></g><g><g><path d="M21,8c-1.45,0-2.26,1.44-1.93,2.51l-3.55,3.56c-0.3-0.09-0.74-0.09-1.04,0l-2.55-2.55C12.27,10.45,11.46,9,10,9 c-1.45,0-2.27,1.44-1.93,2.52l-4.56,4.55C2.44,15.74,1,16.55,1,18c0,1.1,0.9,2,2,2c1.45,0,2.26-1.44,1.93-2.51l4.55-4.56 c0.3,0.09,0.74,0.09,1.04,0l2.55,2.55C12.73,16.55,13.54,18,15,18c1.45,0,2.27-1.44,1.93-2.52l3.56-3.55 C21.56,12.26,23,11.45,23,10C23,8.9,22.1,8,21,8z"/><polygon points="15,9 15.94,6.93 18,6 15.94,5.07 15,3 14.08,5.07 12,6 14.08,6.93"/><polygon points="3.5,11 4,9 6,8.5 4,8 3.5,6 3,8 1,8.5 3,9"/></g></g></svg>',
            onClick: async () => {
              console.log("====以下、自動生成付箋の削除====")
              await deleteAutoCreatedStickers()
              console.log("====以下、PBI毎の合計時間の演算====")
              const hoursInBacklogs = await calculateAllTaskHoursInABacklog()
              console.log("====以下、全PBIの合計時間の演算====")
              const totalHoursInBacklogs = await calculateAllTaskHoursInAllBacklogs(hoursInBacklogs)
              console.log("====以下、1日で消化したタスク時間の演算====")
              const dayDoneTaskHours = await calculateDoneTaskHoursInADay()
              console.log("====以下、1日で確保できる開発時間の取得====")
              const dayFramesInfo = await getHoursPreparedForDevelopmentInEachDays()
              console.log("====以下、1日で消費したバッファの演算====")
              const dayConsumedBuffa = await calculateConsumedBuffaInEachDays(dayDoneTaskHours, dayFramesInfo)
              console.log("====以下、全日で確保できる開発時間の演算====")
              const totalDevelopHours = await calculateAllDevelopmentHours(dayFramesInfo)
              console.log("====以下、全日のバッファの合計の演算====")
              const totalBuffaHours = await calculateTotalBuffaHours(totalHoursInBacklogs, totalDevelopHours)
            }
          }
        }
      })
    })
  </script>
</head>
</html>